<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>TEST PAGE</title>
		<link rel="stylesheet" href="../productList.css" />
	</head>
	<body>
		<h1>
			测试程序读取json
		</h1>
		<button onclick="render_data_to_screen()">click to try get data</button>
		<p id="result"></p>
		<div id="list-container">
			
		</div>
		<script>
			// 按顺序加载 ./main.json 中列出的文件，并返回对象数组
			async function loadSequentialData() {
			    const baseUrl = '.';
			    const result = [];
			
			    try {
			        // 第一步：加载 main.json 获取文件列表
			        const mainResponse = await fetch(`${baseUrl}/main.json`);
			        if (!mainResponse.ok) {
			            throw new Error(`无法加载 main.json: HTTP ${mainResponse.status}`);
			        }
			
			        const mainData = await mainResponse.json();
			        const fileList = mainData.files || [];
			
			        if (fileList.length === 0) {
			            throw new Error('main.json 中没有文件列表');
			        }
			
			        console.log(`main.json 中列出 ${fileList.length} 个文件:`, fileList);
			
			        // 第二步：使用 for 循环逐个加载文件
			        for (const filename of fileList) {
			            try {
			                console.log(`正在加载文件: ${filename}`);
			                const response = await fetch(`${baseUrl}/${filename}`);
			                if (!response.ok) {
			                    throw new Error(`加载失败: ${filename}, HTTP ${response.status}`);
			                }
			
			                const data = await response.json();
			                result.push(data);
			                console.log(`成功加载: ${filename}`);
			            } catch (fileError) {
			                console.warn(`跳过文件 ${filename}，原因:`, fileError);
			            }
			        }
			
			        // 第三步：返回加载好的对象数组
			        console.log(`共加载成功 ${result.length} 个文件, 类型${typeof result}`);
			        return result;
			
			    } catch (error) {
			        console.error('加载数据失败:', error);
			        return [];
			    }
			}
			async function render_data_to_screen() {
			    const productlist = document.getElementById("list-container");
			    const result = await loadSequentialData();
			
			    document.getElementById("result").textContent = JSON.stringify(result, null, 2);
			    console.log(result);
			
			    let content = "";
			    for (let i = 0; i < result.length; i++) {
			        let title = result[i].title;
			        let description = result[i].description;
			        let displayImageUrl = result[i].imagesUrl[0];
			        let imagesRemain = result[i].imagesUrl.length - 1;
			        let isDiscount = result[i].discount.isDiscount;
			        let discountRate = result[i].discount.rate;
			        let discountUntil = result[i].discount.until;
			
			        content += `
			            <div class="list-item">
			              <div class="discount-badge ${(isDiscount == 0 ? "hidden" : "")}">${discountRate}% Off until ${discountUntil}</div>
			              <div class="image-count-badge">+${imagesRemain}</div>
			              <img src="${displayImageUrl}" alt="" />
			              <div class="list-item-description">
			                <h1>${title}</h1>
			                <p>${description}</p>
			              </div>
			            </div>
			        `;
			    }
			    productlist.innerHTML = content;
			}
		</script>
	</body>
</html>